<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Middle-earth Manager v6.4 (Force Fix)</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            alert("VIRHE: " + msg + "\nRivi: " + line);
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAcegclb9zUf2Yk1zi0qjNPvuI43uMsr-M",
          authDomain: "nazgul-campaign.firebaseapp.com",
          databaseURL: "https://nazgul-campaign-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "nazgul-campaign",
          storageBucket: "nazgul-campaign.firebasestorage.app",
          messagingSenderId: "931612776136",
          appId: "1:931612776136:web:091524d064d792e9bc77fd",
          measurementId: "G-7417E5KS9W"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getDatabase(app);
            window.dbRef = ref; window.dbSet = set; window.dbOnValue = onValue; window.dbPush = push;
            console.log("Firebase yhdistetty.");
        } catch (err) { console.error(err); }
    </script>

    <style>
        body { background-color: #202020; color: #d4af37; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #viewport { flex: 3; position: relative; background: #111; overflow: hidden; cursor: grab; display: flex; align-items: center; justify-content: center; }
        #viewport:active { cursor: grabbing; }

        #sidebar { flex: 1; min-width: 380px; background: #1a1a1a; border-left: 2px solid #444; padding: 20px; display: flex; flex-direction: column; z-index: 200; box-shadow: -10px 0 20px rgba(0,0,0,0.5); }
        
        /* KARTTA NÄKYY AINA VÄHINTÄÄN VÄHÄSEN */
        #world { position: absolute; transform-origin: 0 0; display: none; min-width: 100px; min-height: 100px; }
        #game-map { display: block; pointer-events: none; user-select: none; max-width: none; }
        
        #svg-layer, #marker-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #svg-layer { z-index: 1; } #marker-layer { z-index: 2; }

        .marker { position: absolute; transform: translate(-50%, -100%); display: flex; flex-direction: column; align-items: center; cursor: pointer; pointer-events: auto; z-index: 100; }
        .pin { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 5px #000; }
        .label { background: rgba(0,0,0,0.8); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-top: 2px; white-space: nowrap; }
        .region-text { position: absolute; transform: translate(-50%, -50%); font-family: serif; font-weight: bold; font-size: 24px; text-shadow: 0 0 5px #000; pointer-events: none; z-index: 50; text-align: center; white-space: nowrap; }

        .controls { display: flex; gap: 5px; margin-bottom: 10px; }
        button, select, input { background: #333; color: #fff; border: 1px solid #555; padding: 10px; width: 100%; cursor: pointer; }
        .active-tool { background: #d4af37; color: #000; font-weight: bold; }
        
        #log { background: #000; border: 1px solid #333; flex-grow: 1; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 0.85em; color: #ccc; margin-bottom: 10px; }
        
        #start-overlay, #settings-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .box { border: 2px solid #d4af37; padding: 40px; border-radius: 10px; background: #222; text-align: center; max-width: 400px; }
        
        #map-tools, #draw-tools { position: absolute; z-index: 1000; display: none; gap: 10px; }
        #map-tools { bottom: 20px; left: 20px; }
        #draw-tools { top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); padding: 10px; border: 1px solid #d4af37; }
        .float-btn { width: auto; padding: 5px 15px; background: rgba(0,0,0,0.8); border: 1px solid #888; }
        .ai-msg { color: #88ccff; font-style: italic; border-left: 2px solid #88ccff; padding-left: 10px; margin: 5px 0; background: #112233; padding: 5px; }
    </style>
</head>
<body>

    <div id="
